# name: Build MMIP

# on:
#   push:
#     branches:
#       - main
#   workflow_dispatch:

# jobs:
#   build-mmip:
#     name: Build Soundchaser-TagTools.mmip
#     runs-on: windows-latest

#     steps:
#       # 1. Checkout the repo
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       # 2. Set up PowerShell (default on Windows runners)
#       - name: Set execution policy
#         run: Set-ExecutionPolicy Bypass -Scope Process -Force
#         shell: pwsh

#       # 3. Prepare build folder
#       - name: Create build folder
#         run: |
#           $build = "build"
#           if (!(Test-Path $build)) { New-Item -ItemType Directory -Path $build | Out-Null }
#         shell: pwsh

#       # 4. Update version in info.json from version.txt
#       - name: Update info.json version
#         run: |
#           $version = (Get-Content version.txt).Trim()
#           $jsonFile = "src/info.json"
#           $json = Get-Content $jsonFile | ConvertFrom-Json
#           $json.version = $version
#           $json | ConvertTo-Json -Compress | Set-Content $jsonFile
#         shell: pwsh

#       # 5. Build the MMIP package (exclude template.js)
#       - name: Build .mmip
#         run: |
#           $build = "build"
#           if (!(Test-Path $build)) { New-Item -ItemType Directory -Path $build | Out-Null }

#           $zipPath = "$build/Soundchaser-TagTools.zip"

#           # Remove existing zip
#           if (Test-Path $zipPath) { Remove-Item $zipPath }

#           # Gather files, excluding template.js
#           # $filesToZip = Get-ChildItem -Path "src" -Recurse -File | Where-Object { $_.Name -ne 'template.js' }

#           # Compress preserving folder structure
#           Compress-Archive -Path "src/*" -DestinationPath $zipPath -Force
#           Write-Host "✅ Built $zipPath excluding template.js"
#         shell: pwsh

#       # 6. Upload as artifact
#       - name: Upload MMIP artifact as ZIP
#         uses: actions/upload-artifact@v4
#         with:
#           name: Soundchaser-TagTools
#           path: build/Soundchaser-TagTools.zip

#       - name: Upload MMIP artifact
#         uses: actions/upload-artifact@v4
#         with:
#           name: Soundchaser-TagTools.mmip
#           path: build/Soundchaser-TagTools.mmip

#       # 7. Copy the artefact to the repo and rename
#       - name: Create .mmip from ZIP
#         run: |
#           Copy-Item "build/Soundchaser-TagTools.zip" "build/Soundchaser-TagTools.mmip" -Force
#           Write-Host "✅ Created MMIP: build/Soundchaser-TagTools.mmip"


name: Build MMIP

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-mmip:
    name: Build Soundchaser-TagTools.mmip
    runs-on: windows-latest

    steps:
      # 1. Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Set up PowerShell (default on Windows runners)
      - name: Set execution policy
        run: Set-ExecutionPolicy Bypass -Scope Process -Force
        shell: pwsh

      # 3. Prepare build folder
      - name: Create build folder
        run: |
          $build = "build"
          if (!(Test-Path $build)) { New-Item -ItemType Directory -Path $build | Out-Null }
        shell: pwsh

      # 4. Update version in info.json from version.txt
      - name: Update info.json version
        run: |
          $version = (Get-Content version.txt).Trim()
          $jsonFile = "src/info.json"
          $json = Get-Content $jsonFile | ConvertFrom-Json
          $json.version = $version
          $json | ConvertTo-Json -Compress | Set-Content $jsonFile
        shell: pwsh

      # 5. Build the MMIP package (exclude template.js)
      - name: Build .mmip
        run: |
          $build = "build"
          $zipPath = "$build/Soundchaser-TagTools.zip"
          
          # Remove existing zip
          if (Test-Path $zipPath) { Remove-Item $zipPath }
          
          # Create temp directory and copy src contents excluding template.js
          $tempDir = "temp_build"
          if (Test-Path $tempDir) { Remove-Item -Recurse -Force $tempDir }
          Copy-Item -Path "src" -Destination $tempDir -Recurse
          
          # Remove template.js
          $templatePath = "$tempDir/actions/template.js"
          if (Test-Path $templatePath) { 
            Remove-Item $templatePath
            Write-Host "✅ Excluded template.js"
          }
          
          # Compress with src contents as root (not src folder itself)
          Compress-Archive -Path "$tempDir/*" -DestinationPath $zipPath -Force
          
          # Cleanup temp directory
          Remove-Item -Recurse -Force $tempDir
          
          Write-Host "✅ Built $zipPath"
        shell: pwsh

      # 6. Create .mmip from ZIP
      - name: Create .mmip from ZIP
        run: |
          Copy-Item "build/Soundchaser-TagTools.zip" "build/Soundchaser-TagTools.mmip" -Force
          Write-Host "✅ Created MMIP: build/Soundchaser-TagTools.mmip"
        shell: pwsh

      # 7. Commit and push to repo
      - name: Commit and push build artifacts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -f build/Soundchaser-TagTools.zip build/Soundchaser-TagTools.mmip
          git add src/info.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update build artifacts [skip ci]" && git push)
        shell: pwsh

      # 8. Upload as artifacts (optional backup)
      - name: Upload MMIP artifact as ZIP
        uses: actions/upload-artifact@v4
        with:
          name: Soundchaser-TagTools
          path: build/Soundchaser-TagTools.zip

      - name: Upload MMIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: Soundchaser-TagTools.mmip
          path: build/Soundchaser-TagTools.mmip